pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
--gemini
--by vm70

-- todo: find good level curve
-- initiate levels

-- board initiation 
board = {}
boardx = 16
boardy = 16

score = 0
level = 1

-- game initiation
gamestart = false

-- gem sprite vars
gs = {01, 03, 05, 07, 09, 11, 13, 33}

-- board game variables
num_gems = 8
min_match = 3

-- cursor
curx = 3
cury = 3

-- swap varibles
swapstate = false
wt = 3
wd = 1

-- match variables
matchmat = {}
for y=1,6 do
	matchmat[y] = {}
	for x=1,6 do
		matchmat[y][x] = 0
	end
end

mgnum = 0

function wait(a)
	for i = 1,a do
		flip() 
	end
end

-- generate random board state
function rand_board()
	for y=1,6 do
		board[y] = {}
		for x=1,6 do
			board[y][x] = 1 + flr(rnd(num_gems))
		end
	end
end

-- find usable board
function gen_board()
	rand_board()
	det_all_matches()
	gamestart = true
end

-- determine all matches onscreen
-- only used for initiation.
function det_all_matches()
	local loop = true
	while loop == true do
		local matches_made = 0
		for y=1,6 do
			for x=1,6 do
				if det_match(x,y) == true then
					matches_made += 1
				end
			end
		end
		if matches_made == 0 then
			loop = false
			break
		end
		return false
	end
end
	
-- determine a match at a given
-- coordinate
function det_match(x_s,y_s)

	-- initiate match matrix

	matchmat = {}
	for y=1,6 do
		matchmat[y] = {}
		for x=1,6 do
			matchmat[y][x] = 0
		end
	end
	
	s_gc = board[y_s][x_s]
	matchmat[y_s][x_s] = 1
	
	for w=1,36 do -- lazy brute force
		matchmat_init = matchmat
		for y=1,6 do
			for x=1,6 do
				if matchmat[y][x] == 0 then
					
					if x > 1 and 
					board[y][x] == s_gc and
					matchmat[y][x-1] == 1 then
						matchmat[y][x] = 1
				 end
					 
				 if x < 6 and
				 board[y][x] == s_gc and
				 matchmat[y][x+1] == 1 then
				 	matchmat[y][x] = 1
				 end
				 
				 if y > 1 and
				 board[y][x] == s_gc and 
				 matchmat[y-1][x] == 1 then
				 	matchmat[y][x] = 1
				 end
			 
				 if y < 6 and
					board[y][x] == s_gc and
					matchmat[y+1][x] == 1 then
						matchmat[y][x] = 1
					end
				end
			end
		end
	end
	
	mgnum = 0
	
	for y=1,6 do
		for x=1,6 do
			if matchmat[y][x] == 1 then
				mgnum += 1
			end
		end
	end
	
	if mgnum >= min_match then
		for y=1,6 do
			for x=1,6 do
				if matchmat[y][x] == 1 then
					board[y][x] = 0
				end
			end
		end
		wait(wt)
		fill_zeros()
		return true
	else
		return false
	end
end

function check_zeros()
	for y=1,6 do
		for x=1,6 do
			if board[y][x] == 0 then
				return true
			end
		end
	end
end

function fill_zeros()
	if board ~= {} then
		while check_zeros() == true do
			for y=1,6 do
				for x=1,6 do
					if board[y][x] == 0 then
						if y == 1 then
							board[y][x] = flr(rnd(num_gems))
						else
							board[y][x] = board[y-1][x]
							board[y-1][x] = 0
						end
						_draw()
						wait(wd)
					end
				end
			end
		end
		det_all_matches()
	end
end
-- draw a gem at (gx,gy)
function draw_gem(col,gx,gy)
	if col ~= 0 then
		spr(gs[col],gx,gy) -- tl
		spr(gs[col] + 1, gx+8,gy) -- tr
		spr(gs[col] + 16, gx,gy+8) -- bl
		spr(gs[col] + 17, gx+8, gy+8) -- br
	end
end

-- draw the board
function draw_board()
	for y=1,6 do
		for x=1,6 do
			draw_gem(board[y][x],boardx+16*(x-1),boardy+16*(y-1))
		end
	end
end

-- do all cursor actions
function work_cursor()
	if swapstate == false then
		if btnp(0) and curx > 1 then
			curx -= 1
		end
		
		if btnp(1) and curx < 6 then
			curx += 1
		end
	
		if btnp(2) and cury > 1 then
			cury -= 1
		end
	
		if btnp(3) and cury < 6 then
			cury += 1
		end
		
		if btnp(4) or btnp(5) then 
			swapstate = true
		end
		
	else
		if btnp(0) and curx > 1 then
			swap_gems(curx,cury,curx-1,cury)
			swapstate = false
		end
		
		if btnp(1) and curx < 6 then
			swap_gems(curx,cury,curx+1,cury)
			swapstate = false
			
		end
	
		if btnp(2) and cury > 1 then
			swap_gems(curx,cury,curx,cury-1)
			swapstate = false
		end
	
		if btnp(3) and cury < 6 then
			swap_gems(curx,cury,curx,cury+1)
			swapstate = false
		end
		
		if btnp(4) or btnp(5) then
			swapstate = false
		end
	end
end

function swap_gems(x1,y1,x2,y2)
	-- note: x1, y1 was the original selected gem location with cursor
	curx = x2
	cury = y2
	local p = 0
	p = board[y1][x1]
	board[y1][x1] = board[y2][x2]
	board[y2][x2] = p

	_draw()
	
	det_match(x1,y1)
	det_match(x2,y2)
	---- if neither qualify as a valid move, cancel it
	--if det_id_nbs(x1,y1) < 2 and det_id_nbs(x2,y2) < 2 then
	--	p = board[y1][x1]
	--	board[y1][x1] = board[y2][x2]
	--	board[y2][x2] = p
	--	curx = x1
	--	cury = y1
	--end	 
end

-- draws the cursor		
function draw_cursor()
	if swapstate == false then
		rect(boardx+16*(curx-1),boardy+16*(cury-1),boardx+16*curx - 1, boardy+16*cury - 1,7)	
	else		
		rect(boardx+16*(curx-1),boardy+16*(cury-1),boardx+16*curx - 1, boardy+16*cury - 1,11)	
	end
end
				
function _init()
	gen_board()
end

function _draw()
	cls()
	map(0,0,0,0,16,16,0)
	draw_board()
	if gamestart == true then
		draw_cursor()
	end
	----uncomment for matchmat values
	--for y=1,6 do
	--	for x=1,6 do
	-- 	print(matchmat[y][x],boardx+16*(x-1),boardy+16*(y-1))
	--	end
	--end
	--print(mgnum,116,116)
end

function _update()
	if gamestart == true then
		work_cursor()
	end
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
070000700000000770000000000000aaaa0000000007777777777000000000077000000007777777700000000000777777770000000000000000000000000000
0070070000000078870000000000aa9999aa0000001cccccccccc7000000007bb700000002eeeeeee70000000000766666670000000000000000000000000000
000770000000078888700000000a99999999a00001cccccccccccc700000003bb700000002e22222ee700000000d66dddd667000000999999999900000000000
0007700000002882288700000049994444999a0001ccc1111111cc70000003bbbb70000002e7e7772ee70000000d66d66d6670000094aaa44444490000000000
007007000002882772887000004997aaaa499a0001cc7cccccc1cc70000003b73b70000002e72eee72ee700000d6676666d6670002444aaa4444449000000000
0700007000288788872887000499a49999a499a001cc7cccccc1cc7000003bb73bb7000002e72eeee72ee70000d6676666d66700024442222222449000000000
0000000002887288887288700499a49999a499a001cc7cccccc1cc7000003b7bb3b7000002e72eeeee72ee700d667666666d6670024494444442449000000000
0000000002887288887288700499a49999a499a001cc7cccccc1cc700003bb7bb3bb700002ee72eeeee72e700d667666666d6670024494444442449000000000
0000000000288728882887000499a49999a499a001cc7cccccc1cc700003b7bbbb3b7000002ee72eeee72e7000d6676666766700024499999994449000000000
00000000000288722788700000499a4444799a0001cc7cccccc1cc70003bb7bbbb3bb7000002ee72eee72e7000d667666676670002444444aaa4449000000000
000000000000288778820000004999aaaa999a0001cc7777777ccc70003b7bbbbbb3b70000002ee7222e2e70000d66766766d000002444444aaa420000000000
000000000000028888200000000499999999a00001cccccccccccc7003bb77777733bb70000002ee77772e70000d66777766d000000222222222200000000000
0000000000000028820000000000449999440000001cccccccccc70003bbbbbbbbbbbb700000002eeeeeee700000d666666d0000000000000000000000000000
00000000000000022000000000000044440000000001111111111000033333333333377000000002222222700000dddddddd0000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000005dd6000000000000000000000000000000000000000000
00000000000006666660000000000000000000000000000000000000000000000000000000000000005dd6000c7777700c777770000000000000000000000000
0000000000006dddddd6000000000000000000000000000000000000000000000000000000000000005dd60001cccc7661cccc70000000000000000000000000
000000000001dddddddd600000000000000000000000000000000000000000000000000000000000005dd60001cccc7dd1cccc70000700000000700000000000
00000000001ddd1111ddd60000000000000000000000000000000000000000000000000000000000005dd60001cccc7dd1cccc70000070000007000000000000
0000000001ddd660011ddd6000000000000000000000000000000000000000000000000000000000005dd60001cccc7551cccc70000007000070000000000000
0000000001dd66000011dd6000000000000000000000000000000000000000000000000000000000005dd600011111c0011111c0000000700700000000000000
0000000001dd60000001dd6000000000000000000000000000000000000000000000000000000000005dd600005dd600005dd600000000077000000000000000
0000000001dd60000001dd600000000000000000000000000000000000000000000000000000000000000000005dd600005dd600000000077000000000000000
0000000001dd66000061dd6000000000000000000000000000000000000000000000000000000000000000000c7777700c777770000000700700000000000000
0000000001ddd660066ddd60000000000000000000000000000000000000000000000000000000006666666601cccc7661cccc70000007000070000000000000
00000000001ddd6666ddd60000000000000000000000000000000000000000000000000000000000dddddddd01cccc7dd1cccc70000070000007000000000000
000000000001dddddddd100000000000000000000000000000000000000000000000000000000000dddddddd01cccc7dd1cccc70000700000000700000000000
0000000000001dddddd10000000000000000000000000000000000000000000000000000000000005555555501cccc7551cccc70000000000000000000000000
0000000000000111111000000000000000000000000000000000000000000000000000000000000000000000011111c0011111c0000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000aaaa000007700007777770277770000077770000000000006666000000000000000000000000000000000000000000000000000000000000000000
007887000a9999a0000770001cccccc72eeee7000d6666700999999006dddd600000000000000000000000000000000000000000000000000000000000000000
028888704994499a003bb7001cc111c72e22ee700d6dd6702aa444491dd11dd60000000000000000000000000000000000000000000000000000000000000000
2888288749a9949a003bb7001c7cc1c72e7e2ee7d6766d67244222491d6001d60000000000000000000000000000000000000000000000000000000000000000
2887888749a9949a03b73b701c7cc1c72ee7e2e7d6766d67249994491d6001d60000000000000000000000000000000000000000000000000000000000000000
02888870499aa99a03b73b701c777cc702ee72e70d67767024444aa91dd66dd60000000000000000000000000000000000000000000000000000000000000000
00288200049999403bbbbbb71cccccc7002eeee70d6666700222222001dddd600000000000000000000000000000000000000000000000000000000000000000
000220000044440033333377011111100002222200dddd0000000000001111000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000007777777000777777777007700000770099009900000990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077777777700777777777007770007770099009990000990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077ddddddd0077ddddddd007777077770099009999000990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077000000000770000000007777777770099009999900990099000
000000000000000000000000000000000000000000000000000000000000000000000000000770077770007777777000077d777d770099009929990990099000
0000000000000000000000000000000000000000000000000000000000000000000000000007700777770077777770000770d7d0770099009902999990099000
0000000000000000000000000000000000000000000000000000000000000000000000000007700ddd770077ddddd00007700d00770099009900299990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077000007700770000000007700000770099009900029990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077000007700770000000007700000770099009900002990099000
00000000000000000000000000000000000000000000000000000000000000000000000000077777777700777777777007700000770099009900000990099000
000000000000000000000000000000000000000000000000000000000000000000000000000d7777777d00d77777777007700000770099009900000990099000
0000000000000000000000000000000000000000000000000000000000000000000000000000ddddddd0000dddddddd00dd00000dd0022002200000220022000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002b3a3a3a3a3a3a3a3a3a3a3a3a2c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002a0000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
003b3a3a3a3a3a3a3a3a3a3a3a3a3c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
001a0000177551e755217551e755237551e755287551e755277551e755257551e755277551e755237551e755157551c755217551c755237551c755257551c755267551c755257551c755237551c755217551c755
011a0000137551a7551f7551a755217551a755237551a755217551a755237551a755217551a7551f7551a755157551c755217551c755237551c755257551c755267551c755257551c755237551c755217551c755
011a0000177551e755217551e755237551e755287551e755277551e755257551e755277551e755237551e755000001e755007051e755217551e755237551e755007051e755007051e755217551e7552175523755
011a0000235161b516235261b526235361b536235461b546235561b556235461b546235361b536235261b52621516195162152619526215361953621546195462155619556215461954621536195362152619526
011a00001f516175161f526175261f536175361f546175461f556175561f546175461f536175361f5261752621516195162152619526215361953621546195462155619556215461954621536195362152619526
011a0000235161b516235261b526235361b536235461b546235561b556235461b546235361b536235261b5261e516275161e526275261e536275361e546275461e556275561e546275461e536275361e52627526
011a0000173201732017300173250b3200b3201232012320123001232512320123201732017320123201232015320153201730015325153201532010320103200030010325103201032015320153201032010320
011a00001332013320173001332507320073200e3200e320123000e3250e3200e32013320133200e3200e32015320153201730015325153201532010320103200030010325103201032015320153201032010320
011a0000173201732017300173250b3200b320123201232012300123251232012320173201732012320123201732017320173000b32512320123201732017320123000b3250b3200b32012320123201732017320
011a00000c04300000000000c04324615000000c04300000000000c043000000c04324615000000c043000000c04300000000000c04324615000000c04300000000000c043000000c04324615000000c04300000
011a0000000000000017050190501b0501b050170501e0501e050170501e0501b050230501e0501b0501705019050190501c0501c0502005020050210502105020050200501e0501e0501c0501c0502005020050
011a00001e0501e0501e0501705017050170501205012040120401203012030120201202012010120101201000000000001e0502005021050210502005021050210502005021050200501e0501c0501b05017050
011a0000130501305017050170501a0501a05017050170501f0501f0501a0501a05017050170501305013050150501505019050190501c0501c050190501905021050210501c0501a05019050190501505015050
011a00001205012050170501705019050190501b0501b0501e0501e05023050230501e0501e0501b0501b05017050170501205012050150501505017050170501705017000120501205015050120501505017050
011a000013240132301322013210132101321013210132101a2401a2301a2201a2101724017230172201721015240152301522015210122401223012220122101024010230102201021015240152301522015210
011a0000172401723017220172101721017210172101721012240122301222012210122101221012210122101524015230152201521012240122301222012210102401023010220102100d2400d2300d2200d210
011a00000b2400b2300b2200b2101324013230132201321017240172301722017210132401323013220132100d2400d2300d2200d21015240152301522015210192401923019220192101c2401c2301c2201c210
011a00001b246172361b226172161b216172161b21617216132001920019200192001920019200192001920019240192301922019210192101921019210192101724017230172201721017210172101721017210
01160000187551c7551f7552275122750227502175121750217501d7501d7511f7511f7501f7501f7501f7501f7501f7501f75518755187001f7001f7001f7001f7001f7001f7001f7001f7001f7000070000000
0116000013055180551c0551f0511f0501f0501d0511d0501d0501a0501a0511c0511c0501c0501c0501c0501c0501c0501c05513055000000000000000000000000000000000000000000000000000000000000
0116000004555075550c5550f5510f5500f5500e5510e5500e5500a5500a5510c5510c5500c5500c5500c5500c5500c5500c555000550c5000c5000c5000c5000c5000c5000c5000c5000c500000000000000000
__music__
01 00034344
00 00034344
00 01044344
00 02054344
00 00030609
00 00030609
00 01040709
00 02050809
00 0a030609
00 0b030609
00 0c040709
00 0d050809
00 0a030609
00 0b030609
00 0c040709
00 0d050809
00 0e040709
00 0f030609
00 10040709
00 11050809
00 0a030609
00 0b030609
00 0c040709
02 0d050809
00 12131444

